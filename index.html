<html>

<!--
    This is web-workers relative-performance test, designed to be run with,
    python -m SimpleHTTPServer
-->

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />

    <script id="worker" type="application/javascript_worker">
        const TRANSFORM = [
            [0.1527236, -0.9116594, 0.3815136, 4.0000000],
            [0.9756048, 0.2006826, 0.0890043, -7.5000000],
            [-0.1577047, 0.3586135, 0.9200683, 3.2000000],
            [0.0000000, 0.0000000, 0.0000000, 1.0000000],
        ]

        function transform(v) {
            let ret = [0, 0, 0, 0]
            ret[0] = (v[0] * TRANSFORM[0][0]) + (v[1] * TRANSFORM[0][1]) + (v[2] * TRANSFORM[0][2]) + (v[3] * TRANSFORM[0][3])
            ret[1] = (v[0] * TRANSFORM[1][0]) + (v[1] * TRANSFORM[1][1]) + (v[2] * TRANSFORM[1][2]) + (v[3] * TRANSFORM[1][3])
            ret[2] = (v[0] * TRANSFORM[2][0]) + (v[1] * TRANSFORM[2][1]) + (v[2] * TRANSFORM[2][2]) + (v[3] * TRANSFORM[2][3])
            ret[3] = (v[0] * TRANSFORM[3][0]) + (v[1] * TRANSFORM[3][1]) + (v[2] * TRANSFORM[3][2]) + (v[3] * TRANSFORM[3][3])

            v.set(ret)
        }

        self.onmessage = function (m) {
            switch (m.data.type) {
                case ('ping'):
                    self.postMessage(
                        {
                            type: 'pong',
                        },
                    )
                    break
                case ('transform'):
                    m.data.buffers.forEach(e => {
                        let a = new Float64Array(e)
                        transform(a)
                    })
                    self.postMessage(
                        {
                            type: 'transformed',
                            start: m.data.start,
                            end: m.data.end,
                            buffers: m.data.buffers,
                        },
                        m.data.buffers,
                    )
                    break
                case ('transform_one'):
                    let a = new Float64Array(m.data.buffer)
                    transform(a)
                    self.postMessage(
                        {
                            type: 'transformed_one',
                            index: m.data.index,
                            buffer: m.data.buffer,
                        },
                        [m.data.buffer],
                    )
                    break
            }
        }
    </script>
</head>

<body>
    <table>
        <tbody>
            <tr>
                <td>
                    Vector Count:
                </td>
                <td>
                    <input type="text" id="vectCount" value="1000000" /><br />
                </td>
                <td>
                    Vectors Sent:
                </td>
                <td id="vectTx">
                    0
                </td>
            </tr>
            <tr>
                <td>
                    Batch Size:
                </td>
                <td>
                    <input type="text" id="batchSize" value="1000" /><br />
                </td>
                <td>
                    Vectors Received:
                </td>
                <td id="vectRx">
                    0
                </td>
            </tr>
            <tr>
                <td>
                    Worker Count:
                </td>
                <td>
                    <input type="text" id="workerCount" value="8" /><br />
                </td>
                <td id="state" style="width: 18.5rem;">
                    Hit 'Run' when you're ready
                </td>
            </tr>
        </tbody>
    </table>
    <div>
        <button id="run" style="width: 4rem; margin-left: 3rem;">Run</button>
    </div>
    <textarea id="runs" rows="40" cols="80" style="margin: 1rem 1rem;"></textarea>

    <script type="application/javascript" src="./main.js"></script>
</body>

</html>
